<!DOCTYPE html>
<html>
<head>
    <title>BLE WiFi QR</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    
    <link rel="stylesheet" type="text/css" href="css/main.css" />
    <link rel="stylesheet" type="text/css" href="css/elements.css" />

    <meta name="mobile-web-app-capable" content="yes">
	
	<script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script type="text/javascript" src="grid.js"></script>
<script type="text/javascript" src="settings.js"></script>
<script type="text/javascript" src="base64url.js"></script>
<script type="text/javascript" src="cbor.js"></script>
<script type="text/javascript" src="webauthn.js"></script>
<script type="text/javascript">
var DOMContentLoaded = new Promise(resolve => window.addEventListener("DOMContentLoaded", () => resolve()));

var settings = readSettings();
var rp = {};
var user = {
	"name":"hello@example.com",
	"displayName":"Hello Example",
};
var excludeCredentials = "";
var authenticatorSelection = {};
var timeout = "";
var attestation = "";

var publicKeyCredentialCreationOptions_promise;
var publicKeyCredentialCreationOptions;
var publicKeyCredential_promise;
var publicKeyCredential;
var clientDataJSON_promise;
var clientDataJSON;
var attestationObject_promise;
var attestationObject;
var authData_promise;
var authData;
var credentialPublicKey_promise;
var credentialPublicKey;

var properties = [
	// navi
	{
		"id":"navi",
		"title":"[<a href='credential-create.html'>credential-create.html</a>] [<a href='credential-get.html'>credential-get.html</a>] [<a href='credential-edit.html'>credential-edit.html</a>]",
	},
	// isUserVerifyingPlatformAuthenticatorAvailable()
	{
		"id":"isUserVerifyingPlatformAuthenticatorAvailable",
		"title":"isUserVerifyingPlatformAuthenticatorAvailable()",
		"href":"https://w3c.github.io/webauthn/#isUserVerifyingPlatformAuthenticatorAvailable",
		"input":{"type":"text", "readonly":true},
	},
	// PublicKeyCredentialCreationOptions
	{
		"id":"PublicKeyCredentialCreationOptions",
		"href":"https://w3c.github.io/webauthn/#dictdef-publickeycredentialcreationoptions",
	},
	// publicKey.rp
	{
		"id":"publicKey.rp.name",
		"href":"https://w3c.github.io/webauthn/#dictdef-publickeycredentialrpentity",
		"input":{"type":"select", "values":[rp.name = location.origin, "webauthn-tester"]},
		"bind": obj => obj.on("change", e => rp.name = $(e.target).val()),
	},
	{
		"id":"publicKey.rp.id",
		"href":"https://w3c.github.io/webauthn/#dictdef-publickeycredentialrpentity",
		"input":{"type":"select", "values":["", location.host]},
		"bind": obj => obj.on("change", e => rp.id = $(e.target).val()),
	},
	{
		"id":"publicKey.rp.icon",
		"href":"https://w3c.github.io/webauthn/#dictdef-publickeycredentialrpentity",
		"input":{"type":"select", "values":["", location.origin + "/webauthn-tester/rp.png"]},
		"bind": obj => obj.on("change", e => rp.icon = $(e.target).val()),
	},
	// publicKey.user
	{
		"id":"publicKey.user.name",
		"href":"https://w3c.github.io/webauthn/#dictdef-publickeycredentialuserentity",
		"input":{"type":"text"},
		"bind": obj => obj.val(user.name).on("input", e => user.name = $(e.target).val()),
	},
	{
		"id":"publicKey.user.displayName",
		"href":"https://w3c.github.io/webauthn/#dictdef-publickeycredentialuserentity",
		"input":{"type":"text"},
		"bind": obj => obj.val(user.displayName).on("input", e => user.displayName = $(e.target).val()),
	},
	{
		"id":"publicKey.user.icon",
		"href":"https://w3c.github.io/webauthn/#dictdef-publickeycredentialuserentity",
		"input":{"type":"select", "values":["", location.origin + "/webauthn-tester/user.png"]},
		"bind": obj => obj.on("change", e => user.icon = $(e.target).val()),
	},
	// publicKey.excludeCredentials
	{
		"id":"publicKey.excludeCredentials",
		"href":"https://w3c.github.io/webauthn/#dom-publickeycredentialcreationoptions-excludecredentials",
		"input":{"type":"select", "values":[""]},
		"bind": obj => createCredentialsList(obj, settings).on("change", e => excludeCredentials = $(e.target).val()),
	},
	// publicKey.authenticatorSelection
	{
		"id":"publicKey.authenticatorSelection.authenticatorAttachment",
		"href":"https://w3c.github.io/webauthn/#dictdef-authenticatorselectioncriteria",
		"input":{"type":"select", "values":["", "platform", "cross-platform"]},
		"bind": obj => obj.on("change", e => authenticatorSelection.authenticatorAttachment = $(e.target).val()),
	},
	{
		"id":"publicKey.authenticatorSelection.requireResidentKey",
		"href":"https://w3c.github.io/webauthn/#dictdef-authenticatorselectioncriteria",
		"input":{"type":"select", "values":["", "true", "false"]},
		"bind": obj => obj.on("change", e => authenticatorSelection.requireResidentKey = toBoolean($(e.target).val())),
	},
	{
		"id":"publicKey.authenticatorSelection.userVerification",
		"href":"https://w3c.github.io/webauthn/#dictdef-authenticatorselectioncriteria",
		"input":{"type":"select", "values":["", "required", "preferred", "discouraged"]},
		"bind": obj => obj.on("change", e => authenticatorSelection.userVerification = $(e.target).val()),
	},
	// publicKey.timeout
	{
		"id":"publicKey.timeout",
		"href":"https://w3c.github.io/webauthn/#dom-publickeycredentialcreationoptions-timeout",
		"input":{"type":"select", "values":["", "5000", "15000", "30000"]},
		"bind": obj => obj.on("change", e => timeout = $(e.target).val()),
	},
	// publicKey.attestation
	{
		"id":"publicKey.attestation",
		"href":"https://w3c.github.io/webauthn/#enumdef-attestationconveyancepreference",
		"input":{"type":"select", "values":["", "none", "direct", "indirect"]},
		"bind": obj => obj.on("change", e => attestation = $(e.target).val()),
	},
	// PublicKeyCredentialCreationOptions
	{
		"id":"PublicKeyCredentialCreationOptions",
		"title":"",
		"input":{"type":"textarea", "readonly":true}
	},
	// credentials.create()
	{
		"id":"credentials.create",		
		"title":"",
		"input":{"type":"button","value":"credentials.create()"},
		"bind":obj => obj.on("click", CreatePublicKeyCredential),
	},
	// PublicKeyCredential
	{
		"id":"PublicKeyCredential",
		"href":"https://w3c.github.io/webauthn/#publickeycredential",
		"input":{"type":"textarea", "readonly":true}
	},
	// clientDataJSON
	{
		"id":"clientDataJSON",
		"href":"https://w3c.github.io/webauthn/#dom-authenticatorresponse-clientdatajson",
		"input":{"type":"textarea", "readonly":true}
	},
	// attestationObject
	{
		"id":"attestationObject",
		"href":"https://w3c.github.io/webauthn/#dom-authenticatorattestationresponse-attestationobject",
		"input":{"type":"textarea", "readonly":true}
	},
	// authData
	{
		"id":"authData",
		"href":"https://w3c.github.io/webauthn/#authenticator-data",
		"input":{"type":"textarea", "readonly":true}
	},
	// credentialPublicKey
	{
		"id":"credentialPublicKey",
		"href":"https://w3c.github.io/webauthn/#credentialpublickey",
		"input":{"type":"textarea", "readonly":true}
	},
];

function GetPublicKeyCredentialCreationOptions() {
	var challenge_promise = getRandomChallenge();
	return challenge_promise.then(value => {
		var publicKeyCredentialCreationOptions = {
			"publicKey": {
				"rp": {},
				"user": {},
				"challenge":value,
				"pubKeyCredParams":[ 
					{"type": "public-key", "alg": -7},
					{"type": "public-key", "alg": -257},
				],
			}
		};
		if(!rp.name) delete rp.name;
		if(!rp.id) delete rp.id;
		if(!rp.icon) delete rp.icon;
		publicKeyCredentialCreationOptions.publicKey.rp = rp;

		if(!user.name) {
			delete user.name;
			delete user.id;
		} else {
			user.id = Uint8Array.from(user.name, t => t.charCodeAt(0));
		}
		if(!user.displayName) delete user.displayName;
		if(!user.icon) delete user.icon;
		publicKeyCredentialCreationOptions.publicKey.user = user;		

		if(excludeCredentials) {
			publicKeyCredentialCreationOptions.publicKey.excludeCredentials = [];
			if(excludeCredentials == "*") {
				for(var i in settings.credentials) {
					publicKeyCredentialCreationOptions.publicKey.excludeCredentials.push({
						"id":decodeArray(i),
						"type":"public-key",
					});
				}
			} else {
				publicKeyCredentialCreationOptions.publicKey.excludeCredentials.push({
					"id":decodeArray(excludeCredentials),
					"type":"public-key",
				});
			}
		}
		
		
		if(timeout) publicKeyCredentialCreationOptions.publicKey.timeout = Number(timeout);
		
		if(!authenticatorSelection.authenticatorAttachment) delete authenticatorSelection.authenticatorAttachment;
		if(authenticatorSelection.requireResidentKey == null) delete authenticatorSelection.requireResidentKey;
		if(!authenticatorSelection.userVerification) delete authenticatorSelection.userVerification;
		if(Object.keys(authenticatorSelection).length > 0) publicKeyCredentialCreationOptions.publicKey.authenticatorSelection = authenticatorSelection;
		
		if(attestation) publicKeyCredentialCreationOptions.publicKey.attestation = attestation;
		
		return publicKeyCredentialCreationOptions;
	});
}

function CreatePublicKeyCredential() {
	saveSettings(settings);
	
	$("#PublicKeyCredential").val("");
	$("#clientDataJSON").val("");
	$("#attestationObject").val("");
	$("#authData").val("");
	$("#credentialPublicKey").val("");
	
	publicKeyCredential_promise = publicKeyCredentialCreationOptions_promise
		.then(value => navigator_credentials_create(value));
		
	DecodePublicKeyCredential();
}

function DecodePublicKeyCredential() {
	publicKeyCredential_promise
		.then(value => $("#PublicKeyCredential").removeClass("error").val(encodeJson(publicKeyCredential = value)))
		.catch(e => $("#PublicKeyCredential").addClass("error").val(e))

	clientDataJSON_promise = publicKeyCredential_promise
		.then(value => decodeClientDataJSON(value.response.clientDataJSON));
	clientDataJSON_promise
		.then(value => $("#clientDataJSON").val(encodeJson(clientDataJSON = value)))
		.catch(() => {});
	
	attestationObject_promise = publicKeyCredential_promise
		.then(value => decodeAttestationObject(value.response.attestationObject));
	attestationObject_promise
		.then(value => $("#attestationObject").val(encodeJson(attestationObject = value)))
		.catch(() => {});

	authData_promise = attestationObject_promise
		.then(value => decodeAuthenticatorData(value.authData));
	authData_promise
		.then(value => $("#authData").val(encodeJson(authData = value)))
		.catch(() => {});		

	credentialPublicKey_promise = authData_promise
		.then(value => decodeCredentialPublicKey(value.attestedCredentialData.credentialPublicKey));
	credentialPublicKey_promise
		.then(value => $("#credentialPublicKey").val(encodeJson(credentialPublicKey = value)))
		.catch(() => {});

    Promise.all([publicKeyCredential_promise,credentialPublicKey_promise,publicKeyCredentialCreationOptions_promise])
		.then(all => {
			addCredential(settings, all[2].publicKey.user, all[0].id, all[1]);
			createCredentialsList($("#publicKey\\.excludeCredentials"), settings);
		})
		.catch(() => {});
}

function FormChange() {
	publicKeyCredentialCreationOptions_promise = GetPublicKeyCredentialCreationOptions();
	publicKeyCredentialCreationOptions_promise.then(value => $("#PublicKeyCredentialCreationOptions").val(encodeJson(publicKeyCredentialCreationOptions = value)));
}

DOMContentLoaded.then(() => { 
	// CreateGrid(properties, FormChange); 

	// textarea auto-size
	$.valHooks.textarea = {
		set: (e, value) => { e.value = value; $(e).trigger("input"); }
	};
	$('textarea').each(function () {
		this.style.height = (this.scrollHeight) + 'px';
	}).on('input', function () {
		this.style.height = 'auto';
		this.style.height = (this.scrollHeight) + 'px';
	});

	PublicKeyCredential_isUserVerifyingPlatformAuthenticatorAvailable()
		.then(value => $("#isUserVerifyingPlatformAuthenticatorAvailable").toggleClass("error", !value).val(value))
		.catch(e => $("#isUserVerifyingPlatformAuthenticatorAvailable").addClass("error").val("Error: " + e));

	FormChange(); 
});
</script>
<script type="text/javascript">
var DOMContentLoaded = new Promise(resolve => window.addEventListener("DOMContentLoaded", () => resolve()));

var settings = readSettings();
var rpId = "";
var allowCredentials = "";
var userVerification = "";
var timeout = "";

var publicKeyCredentialRequestOptions_promise;
var publicKeyCredentialRequestOptions;
var publicKeyCredential_promise;
var publicKeyCredential;
var clientDataJSON_promise;
var clientDataJSON;
var authenticatorData_promise;
var authenticatorData;
var jwk_promise;
var signature_promise;

var properties1 = [
	// navi
	{
		"id":"navi",
		"title":"[<a href='credential-create.html'>credential-create.html</a>] [<a href='credential-get.html'>credential-get.html</a>] [<a href='credential-edit.html'>credential-edit.html</a>]",
	},
	// isUserVerifyingPlatformAuthenticatorAvailable
	{
		"id":"isUserVerifyingPlatformAuthenticatorAvailable",
		"title":"isUserVerifyingPlatformAuthenticatorAvailable()",
		"href":"https://w3c.github.io/webauthn/#isUserVerifyingPlatformAuthenticatorAvailable",
		"input":{"type":"text", "readonly":true},
	},
	// PublicKeyCredentialRequestOptions
	{
		"id":"PublicKeyCredentialRequestOptions",
		"href":"https://w3c.github.io/webauthn/#dictdef-publickeycredentialrequestoptions",
	},
	// publicKey.rpId
	{
		"id":"publicKey.rpId",
		"href":"https://w3c.github.io/webauthn/#dom-publickeycredentialrequestoptions-rpid",
		"input":{"type":"select", "values":["", location.host]},
		"bind": obj => obj.on("change", e => rpId = $(e.target).val()),
	},
	// publicKey.allowCredentials
	{
		"id":"publicKey.allowCredentials",
		"href":"https://w3c.github.io/webauthn/#dom-publickeycredentialrequestoptions-allowcredentials",
		"input":{"type":"select", "values":[""]},
		"bind": obj => createCredentialsList(obj, settings).on("change", e => allowCredentials = $(e.target).val()),
	},
	// publicKey.userVerification
	{
		"id":"publicKey.userVerification",
		"href":"https://w3c.github.io/webauthn/#enumdef-userverificationrequirement",
		"input":{"type":"select", "values":["", "required", "preferred", "discouraged"]},
		"bind": obj => obj.on("change", e => userVerification = $(e.target).val()),
	},
	// publicKey.timeout
	{
		"id":"publicKey.timeout",
		"href":"https://w3c.github.io/webauthn/#dom-publickeycredentialrequestoptions-timeout",
		"input":{"type":"select", "values":["", "5000", "15000", "30000"]},
		"bind": obj => obj.on("change", e => timeout = $(e.target).val()),
	},
	// PublicKeyCredentialRequestOptions
	{
		"id":"PublicKeyCredentialRequestOptions",
		"title":"",
		"input":{"type":"textarea", "readonly":true}
	},
	// credentials.get()
	{
		"id":"credentials.get",		
		"title":"",
		"input":{"type":"button","value":"credentials.get()"},
		"bind":obj => obj.on("click", GetPublicKeyCredential),
	},
	// PublicKeyCredential
	{
		"id":"PublicKeyCredential",
		"href":"https://w3c.github.io/webauthn/#publickeycredential",
		"input":{"type":"textarea", "readonly":true}
	},
	// clientDataJSON
	{
		"id":"clientDataJSON",
		"href":"https://w3c.github.io/webauthn/#dom-authenticatorresponse-clientdatajson",
		"input":{"type":"textarea", "readonly":true}
	},
	// authenticatorData
	{
		"id":"authenticatorData",
		"href":"https://w3c.github.io/webauthn/#dom-authenticatorassertionresponse-authenticatordata",
		"input":{"type":"textarea", "readonly":true}
	},
	// credentialPublicKey
	{
		"id":"credentialPublicKey",
		"title":"credentialPublicKey (from sessionStorage)",
		"href":"https://w3c.github.io/webauthn/#credentialpublickey",
		"input":{"type":"textarea", "readonly":true}
	},
	// signature
	{
		"id":"signature",
		"href":"https://w3c.github.io/webauthn/#dom-authenticatorassertionresponse-signature",
		"input":{"type":"text", "readonly":true}
	},
];

function GetPublicKeyCredentialRequestOptions() {
	var challenge_promise = getRandomChallenge();
	return challenge_promise.then(value => {
		var publicKeyCredentialRequestOptions = {
			"publicKey": {
				"challenge":value,
			}
		};
		if(rpId) publicKeyCredentialRequestOptions.publicKey.rpId = rpId;

		if(allowCredentials) {
			publicKeyCredentialRequestOptions.publicKey.allowCredentials = [];
			if(allowCredentials == "*") {
				for(var i in settings.credentials) {
					publicKeyCredentialRequestOptions.publicKey.allowCredentials.push({
						"id":decodeArray(i),
						"type":"public-key",
					});
				}
			} else {
				publicKeyCredentialRequestOptions.publicKey.allowCredentials.push({
					"id":decodeArray(allowCredentials),
					"type":"public-key",
				});
			}
		}
		
		
		if(timeout) publicKeyCredentialRequestOptions.publicKey.timeout = Number(timeout);
		
		if(userVerification) publicKeyCredentialRequestOptions.publicKey.userVerification = userVerification;
		
		return publicKeyCredentialRequestOptions;
	});
}

function GetPublicKeyCredential() {
	saveSettings(settings);
	
	$("#PublicKeyCredential").val("");
	$("#clientDataJSON").val("");
	$("#authenticatorData").val("");
	$("#credentialPublicKey").val("");
	$("#signature").val("");
	
	publicKeyCredential_promise = publicKeyCredentialRequestOptions_promise
		.then(value => navigator_credentials_get(value));
		
	DecodePublicKeyCredential();
}

function DecodePublicKeyCredential() {
	publicKeyCredential_promise
		.then(value => $("#PublicKeyCredential").removeClass("error").val(encodeJson(publicKeyCredential = value)))
		.catch(e => $("#PublicKeyCredential").addClass("error").val(e))

	clientDataJSON_promise = publicKeyCredential_promise
		.then(value => decodeClientDataJSON(value.response.clientDataJSON));
	clientDataJSON_promise
		.then(value => $("#clientDataJSON").val(encodeJson(clientDataJSON = value)))
		.catch(() => {});

	authenticatorData_promise = publicKeyCredential_promise
		.then(value => decodeAuthenticatorData(value.response.authenticatorData));
	authenticatorData_promise
		.then(value => $("#authenticatorData").val(encodeJson(authenticatorData = value)))
		.catch(() => {});
	
	jwk_promise = publicKeyCredential_promise
		.then(value => getCredential(settings, value.id))
		.then(value => value.credentialPublicKey);
	jwk_promise
		.then(value => $("#credentialPublicKey").val(encodeJson(value)))
		.catch(() => {});
	
	signature_promise = Promise.all([publicKeyCredential_promise,jwk_promise])
		.then(all => verifyAssertionSignature(all[0], all[1]))
		
	signature_promise
		.then(value => console.log("verifyAssertionSignature: return "+value))
		.catch(e => console.error("verifyAssertionSignature: error "+e));
		
	signature_promise
		.then(value => $("#signature").toggleClass("error", !value).val(value))
		.catch(e => $("#signature").toggleClass("error", true).val("Error: " + e));
}

function FormChange1() {
	publicKeyCredentialRequestOptions_promise = GetPublicKeyCredentialRequestOptions();
	publicKeyCredentialRequestOptions_promise.then(value => $("#PublicKeyCredentialRequestOptions").val(encodeJson(publicKeyCredentialRequestOptions = value)));
}

DOMContentLoaded.then(() => { 
	// CreateGrid(properties1, FormChange1); 

	// textarea auto-size
	$.valHooks.textarea = {
		set: (e, value) => { e.value = value; $(e).trigger("input"); }
	};
	$('textarea').each(function () {
		this.style.height = (this.scrollHeight) + 'px';
	}).on('input', function () {
		this.style.height = 'auto';
		this.style.height = (this.scrollHeight) + 'px';
	});

	PublicKeyCredential_isUserVerifyingPlatformAuthenticatorAvailable()
		.then(value => $("#isUserVerifyingPlatformAuthenticatorAvailable").toggleClass("error", !value).val(value))
		.catch(e => $("#isUserVerifyingPlatformAuthenticatorAvailable").addClass("error").val("Error: " + e));
	
	FormChange1(); 
});
</script>
</head>

<body>
    <div id="bgDiv">
    <fieldset style="width:300px;">
        <legend style="text-align:center;">&nbsp;Bluetooth&nbsp;</legend>
        <p style="font-size: 0.92em;text-align:center;">Device Name Prefix:&nbsp;<br>
            <input type="text" name="nameprefix" id="namePrefix" size="32" maxlength="50" placeholder="Device Name Prefix" style="text-align:center;">
        </p>
        <p style="text-align:center;">
            <button id="scanButton" class="normalButton" onclick="onScanButtonClick()" style="width:290px;">Scan Bluetooth Devices</button>    
        </p>
        <hr>
        <p style="text-align:center;">
            <button id="disconnectButton" class="normalButton" onclick="onDisconnectButtonClick()" style="width:140px;">Disconnect</button>
            <button id="reconnectButton" class="normalButton" onclick="onReconnectButtonClick()" style="width:140px;">Reconnect</button>  
        </p>
    </fieldset>

    <p id="bleStateLabel" style="width:330px;text-align:center;font-size: 0.9em;"></p>
    <br><br>

    <fieldset style="width:300px;">
        <legend style="text-align:center;">&nbsp;WiFi QR Code&nbsp;</legend>
        <p style="text-align:center;">Authentication Type:&nbsp;
            <select id="auth_type" name="selectAuthType">
                <option value="WPA">WPA / WPA2</option>
				<option value="WEP">All</option>
            </select>
        </p>
        <p style="text-align:center;">SSID:&nbsp;
            <textarea rows="2" id="PublicKeyCredential" readonly="readonly" class="error" style="height: 32px;">
			</textarea>
            <input type="button" value="Create" id="credentials.create" onclick = "CreatePublicKeyCredential()">
        </p>
        <p style="text-align:center;">Password:&nbsp;
			<textarea rows="2" id="PublicKeyCredential" readonly="readonly" style="height: 34px;"></textarea>
			<select id="publicKey.allowCredentials">
				<option></option>
				<option value="*">All</option></select>
		    <input type="button" value="Get" id="credentials.get" onclick = "GetPublicKeyCredential()>
        </p>
        <p style="text-align:center;">
            <button id="setupButton" class="normalButton" onclick="onWriteButtonClick()" style="width:290px;background-color:#9d9d9d" disabled>SETUP</button>    
        </p>
    </fieldset>
    
    <p id="setupStateLabel" style="width:330px;text-align:center;font-size: 0.9em;"></p>
    <br>
    </div>
</body>
</html>